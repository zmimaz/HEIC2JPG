<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEICè½¬JPGè½¬æ¢å™¨ - å…è´¹åœ¨çº¿è½¬æ¢è‹¹æœå›¾ç‰‡æ ¼å¼</title>
    <meta name="description" content="å…è´¹åœ¨çº¿HEICè½¬JPGå·¥å…·ï¼Œæ— éœ€å®‰è£…è½¯ä»¶ï¼Œæ”¯æŒæ‰¹é‡è½¬æ¢ï¼Œéšç§å®‰å…¨ï¼Œæ‰€æœ‰å¤„ç†åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆã€‚">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- heic2any: åŸºäºlibheifçš„çº¯å‰ç«¯HEICè§£ç åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* æ‹–æ‹½åŒºåŸŸåŠ¨ç”» */
        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1' stroke-width='3' stroke-dasharray='12%2c 8' stroke-dashoffset='0' stroke-linecap='round'/%3e%3c/svg%3e");
        }
        .drop-zone.drag-over {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233B82F6' stroke-width='3' stroke-dasharray='12%2c 8' stroke-dashoffset='0' stroke-linecap='round'/%3e%3c/svg%3e");
            background-color: #eff6ff;
            transform: scale(1.01);
        }

        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar-fill {
            transition: width 0.4s ease;
        }

        /* æ·¡å…¥åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è„‰å†²åŠ è½½åŠ¨ç”» */
        .pulse-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* æ–‡ä»¶å¡ç‰‡ */
        .file-card {
            transition: all 0.2s ease;
        }
        .file-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* æŒ‰é’®å¾®äº¤äº’ */
        .btn-primary {
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white/70 backdrop-blur-lg border-b border-slate-200/50 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
                <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md shadow-blue-200">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <span class="text-lg font-bold text-slate-800">HEIC<span class="text-blue-600">2</span>JPG</span>
            </div>
            <div class="flex items-center gap-1.5 text-xs text-slate-500 bg-green-50 px-3 py-1.5 rounded-full border border-green-200">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                æœ¬åœ°è½¬æ¢ Â· éšç§å®‰å…¨
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="max-w-5xl mx-auto px-4 sm:px-6 py-8 sm:py-12">

        <!-- Hero åŒºåŸŸ -->
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">
                HEIC å›¾ç‰‡è½¬ JPG
                <span class="bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent"> åœ¨çº¿è½¬æ¢å™¨</span>
            </h1>
            <p class="text-base sm:text-lg text-slate-500 max-w-2xl mx-auto leading-relaxed">
                è‹¹æœè®¾å¤‡æ‹æ‘„çš„ HEIC æ ¼å¼æ— æ³•æ‰“å¼€ï¼Ÿæ‹–å…¥å³å¯è½¬æ¢ä¸ºé€šç”¨ JPG æ ¼å¼ã€‚
                <br class="hidden sm:block">
                <strong class="text-slate-600">å®Œå…¨å…è´¹</strong>ï¼Œæ— éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œæ‰€æœ‰è½¬æ¢åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­æœ¬åœ°å®Œæˆã€‚
            </p>
        </div>

        <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
        <div class="grid grid-cols-3 gap-3 sm:gap-4 mb-8 max-w-2xl mx-auto">
            <div class="text-center p-3 sm:p-4 bg-white/60 rounded-xl border border-slate-200/50">
                <div class="text-2xl mb-1">ğŸ”’</div>
                <div class="text-xs sm:text-sm font-medium text-slate-700">éšç§å®‰å…¨</div>
                <div class="text-xs text-slate-400 mt-0.5 hidden sm:block">æ–‡ä»¶ä¸ç¦»å¼€è®¾å¤‡</div>
            </div>
            <div class="text-center p-3 sm:p-4 bg-white/60 rounded-xl border border-slate-200/50">
                <div class="text-2xl mb-1">âš¡</div>
                <div class="text-xs sm:text-sm font-medium text-slate-700">æé€Ÿè½¬æ¢</div>
                <div class="text-xs text-slate-400 mt-0.5 hidden sm:block">æµè§ˆå™¨æœ¬åœ°å¤„ç†</div>
            </div>
            <div class="text-center p-3 sm:p-4 bg-white/60 rounded-xl border border-slate-200/50">
                <div class="text-2xl mb-1">ğŸ“¦</div>
                <div class="text-xs sm:text-sm font-medium text-slate-700">æ‰¹é‡è½¬æ¢</div>
                <div class="text-xs text-slate-400 mt-0.5 hidden sm:block">ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶</div>
            </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden mb-6">
            <div class="p-6 sm:p-8">
                <div id="dropZone" class="drop-zone rounded-2xl p-8 sm:p-12 text-center cursor-pointer relative">
                    <input type="file" id="fileInput" accept=".heic,.heif,image/heic,image/heif" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    
                    <div id="uploadPrompt">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-5 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8 sm:w-10 sm:h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                        </div>
                        <p class="text-lg sm:text-xl font-semibold text-slate-700 mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½ HEIC æ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <p class="text-sm text-slate-400">æ”¯æŒ .heic / .heif æ ¼å¼ï¼Œå¯å¤šé€‰æ–‡ä»¶æ‰¹é‡è½¬æ¢</p>
                        <p class="text-xs text-slate-300 mt-2">å•ä¸ªæ–‡ä»¶å»ºè®®ä¸è¶…è¿‡ 30MB</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div id="fileListSection" class="hidden mb-6">
            <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-slate-800">å·²é€‰æ–‡ä»¶</h2>
                        <span id="fileCount" class="text-xs bg-blue-100 text-blue-700 px-2.5 py-0.5 rounded-full font-medium">0 ä¸ª</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="addMoreBtn" class="text-sm text-blue-600 hover:text-blue-700 font-medium px-3 py-1.5 hover:bg-blue-50 rounded-lg transition-colors">
                            + ç»§ç»­æ·»åŠ 
                        </button>
                        <button id="clearAllBtn" class="text-sm text-red-500 hover:text-red-600 font-medium px-3 py-1.5 hover:bg-red-50 rounded-lg transition-colors">
                            æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>
                </div>
                <div id="fileList" class="divide-y divide-slate-50 max-h-80 overflow-y-auto">
                    <!-- æ–‡ä»¶é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="p-4 sm:p-6 bg-slate-50/50 border-t border-slate-100">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <!-- è´¨é‡æ»‘å— -->
                        <div class="flex items-center gap-3 flex-1">
                            <label class="text-sm font-medium text-slate-600 whitespace-nowrap">JPG è´¨é‡ï¼š</label>
                            <input type="range" id="qualitySlider" min="0.1" max="1" step="0.05" value="0.92" class="flex-1 accent-blue-500 h-2">
                            <span id="qualityValue" class="text-sm font-bold text-blue-600 min-w-[3rem] text-right">92%</span>
                        </div>
                        <button id="convertBtn" class="btn-primary w-full sm:w-auto bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold px-8 py-3 rounded-xl shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                            <span id="convertBtnText" class="flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                å¼€å§‹è½¬æ¢
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€»è¿›åº¦æ¡ -->
        <div id="totalProgressSection" class="hidden mb-6 fade-in">
            <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden p-6">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-slate-700">æ€»ä½“è¿›åº¦</span>
                    <span id="totalProgressText" class="text-sm font-bold text-blue-600">0 / 0</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div id="totalProgressBar" class="progress-bar-fill h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- è½¬æ¢ç»“æœåŒºåŸŸ -->
        <div id="resultSection" class="hidden mb-6 fade-in">
            <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-slate-200/50 overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h2 class="text-lg font-bold text-slate-800">è½¬æ¢å®Œæˆ</h2>
                        <span id="resultCount" class="text-xs bg-green-100 text-green-700 px-2.5 py-0.5 rounded-full font-medium">0 ä¸ª</span>
                    </div>
                    <button id="downloadAllBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all hover:-translate-y-0.5">
                        <span class="flex items-center gap-1.5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            å…¨éƒ¨ä¸‹è½½
                        </span>
                    </button>
                </div>
                <div id="resultList" class="divide-y divide-slate-50 max-h-96 overflow-y-auto">
                    <!-- ç»“æœé¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>

        <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
        <div id="errorSection" class="hidden mb-6 fade-in">
            <div class="bg-red-50 rounded-2xl border border-red-200 p-5">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-red-800 mb-1">è½¬æ¢å‡ºé”™</h3>
                        <p id="errorMessage" class="text-sm text-red-600"></p>
                    </div>
                    <button id="closeError" class="ml-auto text-red-400 hover:text-red-600 flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- FAQ åŒºåŸŸ -->
        <div class="mt-12 mb-8">
            <h2 class="text-2xl font-bold text-slate-800 text-center mb-8">å¸¸è§é—®é¢˜</h2>
            <div class="grid sm:grid-cols-2 gap-4 max-w-3xl mx-auto">
                <div class="bg-white/70 rounded-xl p-5 border border-slate-200/50">
                    <h3 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-blue-500">Q:</span> ä»€ä¹ˆæ˜¯ HEIC æ ¼å¼ï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-500 leading-relaxed">HEICï¼ˆHigh Efficiency Image Containerï¼‰æ˜¯è‹¹æœå…¬å¸åœ¨ iOS 11 ä¹‹åé‡‡ç”¨çš„é»˜è®¤å›¾ç‰‡æ ¼å¼ã€‚å®ƒæ¯” JPG å‹ç¼©ç‡æ›´é«˜ã€è´¨é‡æ›´å¥½ï¼Œä½†åœ¨ Windows å’Œå®‰å“è®¾å¤‡ä¸Šå…¼å®¹æ€§è¾ƒå·®ã€‚</p>
                </div>
                <div class="bg-white/70 rounded-xl p-5 border border-slate-200/50">
                    <h3 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-blue-500">Q:</span> æˆ‘çš„å›¾ç‰‡ä¼šè¢«ä¸Šä¼ å—ï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-500 leading-relaxed">ä¸ä¼šï¼æ‰€æœ‰è½¬æ¢è¿‡ç¨‹100%åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­æœ¬åœ°å®Œæˆï¼Œæ‚¨çš„å›¾ç‰‡ä¸ä¼šè¢«ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚å…³é—­ç½‘é¡µåï¼Œæ‰€æœ‰æ•°æ®å³æ¶ˆå¤±ã€‚</p>
                </div>
                <div class="bg-white/70 rounded-xl p-5 border border-slate-200/50">
                    <h3 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-blue-500">Q:</span> æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-500 leading-relaxed">æ¨èä½¿ç”¨æœ€æ–°ç‰ˆçš„ Chromeã€Edgeã€Firefox æˆ– Safari æµè§ˆå™¨ã€‚ç”±äºä½¿ç”¨äº† WebAssembly æŠ€æœ¯ï¼Œéœ€è¦è¾ƒæ–°çš„æµè§ˆå™¨ç‰ˆæœ¬ã€‚</p>
                </div>
                <div class="bg-white/70 rounded-xl p-5 border border-slate-200/50">
                    <h3 class="font-semibold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-blue-500">Q:</span> è½¬æ¢åçš„è´¨é‡å¦‚ä½•ï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-500 leading-relaxed">é»˜è®¤è½¬æ¢è´¨é‡ä¸º 92%ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ»‘å—è‡ªè¡Œè°ƒèŠ‚ã€‚è´¨é‡è¶Šé«˜æ–‡ä»¶è¶Šå¤§ï¼Œ92% æ˜¯è§†è§‰è´¨é‡ä¸æ–‡ä»¶å¤§å°çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="border-t border-slate-200/50 bg-white/50 backdrop-blur-sm">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-6 text-center">
            <p class="text-sm text-slate-400">
                HEIC2JPG åœ¨çº¿è½¬æ¢å™¨ Â· å…è´¹ Â· å¼€æº Â· éšç§å®‰å…¨
            </p>
            <p class="text-xs text-slate-300 mt-1">
                åŸºäº <a href="https://github.com/nichenqin/heic2any" target="_blank" class="underline hover:text-slate-500">heic2any</a> å’Œ <a href="https://github.com/nichenqin/libheif-js" target="_blank" class="underline hover:text-slate-500">libheif</a> æ„å»º
            </p>
        </div>
    </footer>

    <!-- éšè—çš„é¢å¤–æ–‡ä»¶è¾“å…¥æ¡†ï¼ˆç”¨äº"ç»§ç»­æ·»åŠ "åŠŸèƒ½ï¼‰ -->
    <input type="file" id="addMoreInput" accept=".heic,.heif,image/heic,image/heif" multiple class="hidden">

    <script>
    (function() {
        'use strict';

        // ==================== DOM å…ƒç´ å¼•ç”¨ ====================
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const addMoreInput = document.getElementById('addMoreInput');
        const fileListSection = document.getElementById('fileListSection');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const convertBtn = document.getElementById('convertBtn');
        const convertBtnText = document.getElementById('convertBtnText');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const totalProgressSection = document.getElementById('totalProgressSection');
        const totalProgressBar = document.getElementById('totalProgressBar');
        const totalProgressText = document.getElementById('totalProgressText');
        const resultSection = document.getElementById('resultSection');
        const resultList = document.getElementById('resultList');
        const resultCount = document.getElementById('resultCount');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const errorSection = document.getElementById('errorSection');
        const errorMessage = document.getElementById('errorMessage');
        const closeError = document.getElementById('closeError');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');

        // ==================== çŠ¶æ€ç®¡ç† ====================
        let selectedFiles = [];      // ç”¨æˆ·é€‰ä¸­çš„HEICæ–‡ä»¶
        let convertedResults = [];   // è½¬æ¢å®Œæˆçš„ç»“æœ
        let isConverting = false;    // æ˜¯å¦æ­£åœ¨è½¬æ¢ä¸­

        // ==================== å·¥å…·å‡½æ•° ====================
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileNameWithoutExt(name) {
            return name.replace(/\.[^/.]+$/, '');
        }

        function isHEICFile(file) {
            const name = file.name.toLowerCase();
            const type = file.type.toLowerCase();
            return name.endsWith('.heic') || name.endsWith('.heif') || 
                   type === 'image/heic' || type === 'image/heif' ||
                   type === 'image/heic-sequence' || type === 'image/heif-sequence';
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorSection.classList.remove('hidden');
            errorSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function hideError() {
            errorSection.classList.add('hidden');
        }

        // ==================== æ‹–æ‹½äº¤äº’ ====================
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // ==================== æ–‡ä»¶é€‰æ‹© ====================
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
            e.target.value = ''; // é‡ç½®ä»¥å…è®¸é‡æ–°é€‰æ‹©åŒä¸€æ–‡ä»¶
        });

        addMoreInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
            e.target.value = '';
        });

        addMoreBtn.addEventListener('click', () => {
            addMoreInput.click();
        });

        clearAllBtn.addEventListener('click', () => {
            selectedFiles = [];
            renderFileList();
            fileListSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            totalProgressSection.classList.add('hidden');
            convertedResults = [];
        });

        // ==================== å¤„ç†æ–‡ä»¶é€‰æ‹© ====================
        function handleFiles(files) {
            hideError();

            if (files.length === 0) return;

            // è¿‡æ»¤å‡ºHEICæ–‡ä»¶
            const heicFiles = files.filter(f => isHEICFile(f));
            const skipped = files.length - heicFiles.length;

            if (heicFiles.length === 0) {
                showError('æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„ HEIC/HEIF æ–‡ä»¶ã€‚è¯·ç¡®ä¿æ‚¨é€‰æ‹©çš„æ˜¯è‹¹æœè®¾å¤‡æ‹æ‘„çš„ .heic æˆ– .heif æ ¼å¼å›¾ç‰‡ã€‚');
                return;
            }

            if (skipped > 0) {
                showError(`å·²è·³è¿‡ ${skipped} ä¸ªé HEIC æ ¼å¼æ–‡ä»¶ï¼Œä»…ä¿ç•™äº† ${heicFiles.length} ä¸ª HEIC æ–‡ä»¶ã€‚`);
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            const oversized = heicFiles.filter(f => f.size > 50 * 1024 * 1024);
            if (oversized.length > 0) {
                showError(`${oversized.length} ä¸ªæ–‡ä»¶è¶…è¿‡ 50MB é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´è½¬æ¢å¤±è´¥ã€‚`);
            }

            // æ·»åŠ åˆ°åˆ—è¡¨ï¼ˆå»é‡ï¼‰
            heicFiles.forEach(file => {
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });

            renderFileList();
            fileListSection.classList.remove('hidden');
            fileListSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ==================== æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ ====================
        function renderFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = `${selectedFiles.length} ä¸ª`;

            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-card flex items-center gap-3 sm:gap-4 px-4 sm:px-6 py-3 hover:bg-slate-50/80';
                item.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-100 to-orange-100 rounded-xl flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-700 truncate">${file.name}</p>
                        <p class="text-xs text-slate-400">${formatFileSize(file.size)}</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <div id="status-${index}" class="text-xs text-slate-400">ç­‰å¾…è½¬æ¢</div>
                        <button class="remove-btn text-slate-300 hover:text-red-500 transition-colors p-1" data-index="${index}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
                fileList.appendChild(item);
            });

            // ç»‘å®šåˆ é™¤æŒ‰é’®
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (isConverting) return;
                    const idx = parseInt(btn.dataset.index);
                    selectedFiles.splice(idx, 1);
                    renderFileList();
                    if (selectedFiles.length === 0) {
                        fileListSection.classList.add('hidden');
                    }
                });
            });

            convertBtn.disabled = selectedFiles.length === 0;
        }

        // ==================== è´¨é‡æ»‘å— ====================
        qualitySlider.addEventListener('input', () => {
            const val = Math.round(qualitySlider.value * 100);
            qualityValue.textContent = val + '%';
        });

        // ==================== æ ¸å¿ƒï¼šè½¬æ¢é€»è¾‘ ====================
        convertBtn.addEventListener('click', startConversion);

        async function startConversion() {
            if (isConverting || selectedFiles.length === 0) return;

            isConverting = true;
            hideError();
            convertedResults = [];

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            convertBtn.disabled = true;
            convertBtnText.innerHTML = `
                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                è½¬æ¢ä¸­...
            `;

            // æ˜¾ç¤ºæ€»è¿›åº¦
            totalProgressSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            resultList.innerHTML = '';

            const quality = parseFloat(qualitySlider.value);
            const total = selectedFiles.length;
            let completed = 0;
            let errors = [];

            // é€ä¸ªè½¬æ¢ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰
            for (let i = 0; i < total; i++) {
                const file = selectedFiles[i];
                const statusEl = document.getElementById(`status-${i}`);

                // æ›´æ–°çŠ¶æ€ä¸º"è½¬æ¢ä¸­"
                if (statusEl) {
                    statusEl.innerHTML = '<span class="text-blue-500 pulse-loading">è½¬æ¢ä¸­...</span>';
                }

                try {
                    const blob = await heic2any({
                        blob: file,
                        toType: 'image/jpeg',
                        quality: quality
                    });

                    // heic2any å¯èƒ½è¿”å›å•ä¸ªblobæˆ–blobæ•°ç»„ï¼ˆå¤šå¸§å›¾åƒï¼‰
                    const resultBlob = Array.isArray(blob) ? blob[0] : blob;
                    const jpgName = getFileNameWithoutExt(file.name) + '.jpg';
                    const url = URL.createObjectURL(resultBlob);

                    convertedResults.push({
                        name: jpgName,
                        originalName: file.name,
                        originalSize: file.size,
                        size: resultBlob.size,
                        url: url,
                        blob: resultBlob
                    });

                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-green-600 font-medium">âœ“ å®Œæˆ</span>';
                    }
                } catch (err) {
                    console.error(`è½¬æ¢å¤±è´¥: ${file.name}`, err);
                    errors.push(file.name);
                    if (statusEl) {
                        statusEl.innerHTML = '<span class="text-red-500 font-medium">âœ— å¤±è´¥</span>';
                    }
                }

                completed++;
                const percent = Math.round((completed / total) * 100);
                totalProgressBar.style.width = percent + '%';
                totalProgressText.textContent = `${completed} / ${total}`;
            }

            // è½¬æ¢å®Œæ¯•
            isConverting = false;
            convertBtn.disabled = false;
            convertBtnText.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                å¼€å§‹è½¬æ¢
            `;

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (errors.length > 0) {
                showError(`ä»¥ä¸‹æ–‡ä»¶è½¬æ¢å¤±è´¥ï¼š${errors.join('ã€')}ã€‚å¯èƒ½åŸå› ï¼šæ–‡ä»¶æŸåã€æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶è¿‡å¤§ã€‚`);
            }

            // æ˜¾ç¤ºç»“æœ
            if (convertedResults.length > 0) {
                renderResults();
            }
        }

        // ==================== æ¸²æŸ“è½¬æ¢ç»“æœ ====================
        function renderResults() {
            resultSection.classList.remove('hidden');
            resultList.innerHTML = '';
            resultCount.textContent = `${convertedResults.length} ä¸ª`;

            convertedResults.forEach((result, index) => {
                const compression = ((1 - result.size / result.originalSize) * 100).toFixed(0);
                const item = document.createElement('div');
                item.className = 'fade-in flex items-center gap-3 sm:gap-4 px-4 sm:px-6 py-3 hover:bg-slate-50/80';
                item.style.animationDelay = `${index * 0.08}s`;
                item.innerHTML = `
                    <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-xl overflow-hidden flex-shrink-0 bg-slate-100 border border-slate-200">
                        <img src="${result.url}" alt="${result.name}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-slate-700 truncate">${result.name}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-xs text-slate-400">${formatFileSize(result.size)}</span>
                            <span class="text-xs ${parseInt(compression) > 0 ? 'text-green-500' : 'text-orange-500'}">
                                ${parseInt(compression) > 0 ? 'â†“' : 'â†‘'} ${Math.abs(compression)}%
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button class="preview-btn text-slate-400 hover:text-blue-500 transition-colors p-2" data-index="${index}" title="é¢„è§ˆ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                        <a href="${result.url}" download="${result.name}" class="bg-blue-50 text-blue-600 hover:bg-blue-100 text-xs font-medium px-3 py-1.5 rounded-lg transition-colors">
                            ä¸‹è½½
                        </a>
                    </div>
                `;
                resultList.appendChild(item);
            });

            // ç»‘å®šé¢„è§ˆæŒ‰é’®
            document.querySelectorAll('.preview-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.index);
                    openPreview(convertedResults[idx]);
                });
            });

            resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ==================== é¢„è§ˆå¼¹çª— ====================
        function openPreview(result) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 fade-in';
            overlay.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh] w-full">
                    <button class="absolute -top-10 right-0 text-white/80 hover:text-white transition-colors">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                    <img src="${result.url}" alt="${result.name}" class="w-full h-full object-contain rounded-lg">
                    <p class="text-center text-white/60 text-sm mt-3">${result.name} Â· ${formatFileSize(result.size)}</p>
                </div>
            `;
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay || e.target.closest('button')) {
                    overlay.remove();
                }
            });
            document.addEventListener('keydown', function handler(e) {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', handler);
                }
            });
            document.body.appendChild(overlay);
        }

        // ==================== å…¨éƒ¨ä¸‹è½½ ====================
        downloadAllBtn.addEventListener('click', () => {
            if (convertedResults.length === 0) return;

            if (convertedResults.length === 1) {
                // å•æ–‡ä»¶ç›´æ¥ä¸‹è½½
                const a = document.createElement('a');
                a.href = convertedResults[0].url;
                a.download = convertedResults[0].name;
                a.click();
            } else {
                // å¤šæ–‡ä»¶é€ä¸ªè§¦å‘ä¸‹è½½
                convertedResults.forEach((result, i) => {
                    setTimeout(() => {
                        const a = document.createElement('a');
                        a.href = result.url;
                        a.download = result.name;
                        a.click();
                    }, i * 300);
                });
            }
        });

        // ==================== å…³é—­é”™è¯¯æç¤º ====================
        closeError.addEventListener('click', hideError);

        // ==================== é¡µé¢ç¦»å¼€å‰æ¸…ç† ====================
        window.addEventListener('beforeunload', () => {
            convertedResults.forEach(r => URL.revokeObjectURL(r.url));
        });

    })();
    </script>
</body>
</html>
